#!/bin/bash

# STATION INFO
MYCALL=$(head -n 1 $HOME/.station-info)
MYNAME=$(head -n 2 $HOME/.station-info | tail -n 1)
MYCITY=$(head -n 3 $HOME/.station-info | tail -n 1)
MYST=$(head -n 4 $HOME/.station-info | tail -n 1)
MYQTH="${MYCITY}, ${MYST}"
MYLOC=$(head -n 5 $HOME/.station-info | tail -n 1)

# PATHS
ARCOS_DATA=/media/$USER/ARCOS-DATA
########################

update () {
notify-send --icon=update-manager "Updating QRV Modules..."

rm /tmp/active-modules

#//COMMUNITY
for active in $(find /media/user/ARCOS-DATA/QRV/$MYCALL/arcos-linux-modules/COMMUNITY -maxdepth 1 -type f -name "*.sh" | grep "[0-9][0-9]_.*\.sh" | awk -F "/" '{print $8"/"$9}'); do
	echo "$active" >> /tmp/active-modules
	active_dir=$(echo "$active" | awk -F "/" '{print $2}' | awk -F "_" '{print $2}' | awk -F "." '{print $1}')
	rm $ARCOS_DATA/QRV/$MYCALL/arcos-linux-modules/$active
done

#//UPDATE MODULES
cd $ARCOS_DATA/QRV/${MYCALL}/arcos-linux-modules
git fetch --all
git reset --hard origin/main
git clean ./CORE
git clean ./COMMUNITY
for i in $(find /media/user/ARCOS-DATA/QRV/${MYCALL}/arcos-linux-modules/CORE -maxdepth 2 -type f -name "*.sh" | grep "[0-9][0-9]_.*\.sh"); do
	mv "$i" /media/user/ARCOS-DATA/QRV/${MYCALL}/arcos-linux-modules/CORE/
done
	
#//re-enable previously "active" modules//
#//COMMUNITY
for active in $(cat /tmp/active-modules | grep COMMUNITY); do
	active_dir=$(echo "$active" | awk -F "/" '{print $2}' | awk -F "_" '{print $2}' | awk -F "." '{print $1}')
	mv $ARCOS_DATA/QRV/$MYCALL/arcos-linux-modules/COMMUNITY/$active_dir/00_$active_dir.sh $ARCOS_DATA/QRV/$MYCALL/arcos-linux-modules/$active
done
}

if ping -c 1 8.8.8.8 > /dev/null; then
	if update; then
		notify-send --urgency=critical --icon=update-manager "QRV Modules updated!" "Reboot to complete the update."
	else
		notify-send --icon=error "Error updating QRV Modules!"
	fi
else
	notify-send --icon=error "Internet connection required!" "Updating QRV Modules requires an internet connection. Please connect to a network, and try again."	
fi


